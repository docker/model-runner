name: Release model-cli
run-name: >-
  Release model-cli
  ${{ inputs.releaseTag != '' && inputs.releaseTag || format('(auto {0} bump)', inputs.bumpType || 'patch') }}

on:
  workflow_dispatch:
    inputs:
      bumpType:
        description: "Version bump type (ignored when releaseTag is provided)"
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: "patch"
      releaseTag:
        description: "Explicit release tag ‚Äî overrides auto-bump (e.g., v1.2.3)"
        required: false
        type: string
      skipPackaging:
        description: "Skip triggering packaging/CE release workflows"
        required: false
        type: boolean
        default: false

jobs:
  # ---------------------------------------------------------------------------
  # Determine or create the CLI release tag.
  # Auto-bumps the latest cmd/cli/v* tag (or uses explicit releaseTag).
  # ---------------------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
      version: ${{ steps.resolve.outputs.version }}
      previous_tag: ${{ steps.resolve.outputs.previous_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: resolve
        env:
          EXPLICIT_TAG: ${{ inputs.releaseTag }}
          BUMP_TYPE: ${{ inputs.bumpType || 'patch' }}
        run: |
          # --- Find the latest existing cmd/cli/v* tag ---
          LATEST_TAG=$(git tag --list 'cmd/cli/v*' --sort=-v:refname | head -1)
          echo "Latest existing CLI tag: ${LATEST_TAG:-<none>}"

          if [ -n "$EXPLICIT_TAG" ]; then
            # Validate explicit tag format (accept with or without v prefix)
            if ! echo "$EXPLICIT_TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "::error::Invalid release tag format: '$EXPLICIT_TAG'. Expected format: v<MAJOR>.<MINOR>.<PATCH> (e.g., v1.2.3)"
              exit 1
            fi
            VERSION="${EXPLICIT_TAG#v}"
            RELEASE_TAG="cmd/cli/$EXPLICIT_TAG"
            PREVIOUS_TAG="$LATEST_TAG"
            echo "Explicit tag provided: $RELEASE_TAG"

          else
            # Auto-bump from latest tag
            if [ -z "$LATEST_TAG" ]; then
              echo "No existing CLI tags found ‚Äî starting at cmd/cli/v0.1.0"
              VERSION="0.1.0"
              RELEASE_TAG="cmd/cli/v0.1.0"
              PREVIOUS_TAG=""
            else
              PREVIOUS_TAG="$LATEST_TAG"
              # Strip prefix for parsing: cmd/cli/v1.2.3 -> 1.2.3
              VERSION="${LATEST_TAG#cmd/cli/v}"
              MAJOR=$(echo "$VERSION" | cut -d. -f1)
              MINOR=$(echo "$VERSION" | cut -d. -f2)
              PATCH=$(echo "$VERSION" | cut -d. -f3)

              case "$BUMP_TYPE" in
                major)
                  MAJOR=$((MAJOR + 1))
                  MINOR=0
                  PATCH=0
                  ;;
                minor)
                  MINOR=$((MINOR + 1))
                  PATCH=0
                  ;;
                patch)
                  PATCH=$((PATCH + 1))
                  ;;
              esac

              VERSION="${MAJOR}.${MINOR}.${PATCH}"
              RELEASE_TAG="cmd/cli/v${VERSION}"
              echo "Auto-bumped $BUMP_TYPE: $LATEST_TAG ‚Üí $RELEASE_TAG"
            fi
          fi

          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "previous_tag=${PREVIOUS_TAG:-}" >> "$GITHUB_OUTPUT"
          echo "üè∑Ô∏è  Release tag:  $RELEASE_TAG"
          echo "üè∑Ô∏è  Version:      $VERSION"
          echo "üè∑Ô∏è  Previous tag: ${PREVIOUS_TAG:-<none>}"

      - name: Create and push tag
        env:
          RELEASE_TAG: ${{ steps.resolve.outputs.release_tag }}
        run: |
          # Check if the tag already exists
          if git rev-parse "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $RELEASE_TAG already exists ‚Äî skipping creation"
            exit 0
          fi

          echo "Creating tag $RELEASE_TAG on $(git rev-parse --short HEAD)"
          git tag "$RELEASE_TAG"
          git push origin "$RELEASE_TAG"
          echo "‚úÖ Tag $RELEASE_TAG created and pushed"

  # ---------------------------------------------------------------------------
  # Generate release notes using cagent AI agent
  # ---------------------------------------------------------------------------
  release-notes:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Generate release notes
        uses: docker/cagent-action@a893bceeae87a21b91ca2b09459365e51f765e5d
        with:
          agent: .github/agents/cli-release-notes-generator.yaml
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            **Release Tag:** ${{ needs.prepare.outputs.release_tag }}
            **Previous Tag:** ${{ needs.prepare.outputs.previous_tag }}
            **Repository:** docker/model-runner

      - name: Verify release notes
        env:
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
          PREVIOUS_TAG: ${{ needs.prepare.outputs.previous_tag }}
        run: |
          if [ ! -f "release-notes.md" ]; then
            echo "::warning::Release notes were not generated. Using fallback."
            echo "## What's Changed" > release-notes.md
            echo "" >> release-notes.md
            if [ -n "$PREVIOUS_TAG" ]; then
              echo "**Full Changelog**: https://github.com/docker/model-runner/compare/${PREVIOUS_TAG}...${RELEASE_TAG}" >> release-notes.md
            else
              echo "**Full Changelog**: https://github.com/docker/model-runner/tree/${RELEASE_TAG}" >> release-notes.md
            fi
          fi
          echo "‚úÖ Release notes:"
          cat release-notes.md

      - name: Upload release notes
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: release-notes
          path: release-notes.md

  # ---------------------------------------------------------------------------
  # Run CLI tests
  # ---------------------------------------------------------------------------
  test:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version-file: cmd/cli/go.mod
          cache: true
          cache-dependency-path: cmd/cli/go.sum

      - name: Run CLI tests
        working-directory: cmd/cli
        run: go test -race ./...

  # ---------------------------------------------------------------------------
  # Trigger model-cli-release workflow (private repo ‚Äî signs binaries)
  # ---------------------------------------------------------------------------
  trigger-model-cli-release:
    needs: [prepare, test, release-notes]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download release notes
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: release-notes

      - name: Read release notes
        id: notes
        run: |
          # Read release notes and set as output (escape for JSON)
          NOTES=$(cat release-notes.md)
          echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Trigger model-cli-release workflow
        env:
          GH_TOKEN: ${{ secrets.CLI_RELEASE_PAT }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo "üöÄ Triggering model-cli-release workflow"
          echo "   ref: $RELEASE_TAG"
          echo "   release_tag: v$VERSION"
          gh workflow run release.yml \
            --repo docker/model-cli-release \
            -f ref="$RELEASE_TAG" \
            -f release_tag="v$VERSION" \
            -f changelog="${{ steps.notes.outputs.changelog }}"
          echo "‚úÖ model-cli-release workflow triggered"

  # ---------------------------------------------------------------------------
  # Trigger Docker CE packaging workflow
  # ---------------------------------------------------------------------------
  trigger-packaging:
    if: ${{ !inputs.skipPackaging }}
    needs: [prepare, trigger-model-cli-release]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger release-model workflow in packaging repo
        env:
          GH_TOKEN: ${{ secrets.CLI_RELEASE_PAT }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
        run: |
          echo "üì¶ Triggering release-model workflow in docker/packaging"
          echo "   tag_ref: $RELEASE_TAG"
          gh workflow run release-model.yml \
            --repo docker/packaging \
            -f tag="$RELEASE_TAG"
          echo "‚úÖ release-model workflow triggered in docker/packaging"

      - name: Post instructions for release-repo
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<-SUMMARY
          ## üìã Next Steps: Release to Docker CE

          The \`release-model\` workflow has been triggered in \`docker/packaging\`.
          Once it completes, follow these manual steps:

          ### 1. Get the packaging image tag

          Check the [release-model workflow runs](https://github.com/docker/packaging/actions/workflows/release-model.yml)
          for the image tag. It will look like:
          \`\`\`
          dockereng/packaging:model-v${VERSION}-<build_number>
          \`\`\`

          ### 2. Trigger the plugin release

          Run the [release buildx, compose, model, cagent](https://github.com/docker/release-repo/actions/workflows/plugin.yml) workflow with:

          | Parameter | Value |
          |-----------|-------|
          | **Image** | \`dockereng/packaging:model-v${VERSION}-<build_number>\` |
          | **Expected version** | \`${VERSION}\` (no v-prefix) |
          | **Release channel** | \`stable\` |
          | **Deploy to live** | ‚úÖ Yes |

          > **Tag reference used:** \`${RELEASE_TAG}\`
          SUMMARY

          echo "üìã Instructions for docker/release-repo have been added to the job summary"

  # ---------------------------------------------------------------------------
  # Create GitHub Release with AI-generated release notes
  # ---------------------------------------------------------------------------
  github-release:
    needs: [prepare, release-notes, trigger-model-cli-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download release notes
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: release-notes

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo "Creating GitHub Release for $RELEASE_TAG"
          gh release create "$RELEASE_TAG" \
            --repo docker/model-runner \
            --title "Docker Model CLI v$VERSION" \
            --notes-file release-notes.md
