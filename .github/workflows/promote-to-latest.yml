name: Promote docker/model-runner to latest
run-name: Promote docker/model-runner version ${{ inputs.version }} to latest

on:
  workflow_dispatch:
    inputs:
      version:
        description: "version"
        required: true
        type: string

jobs:
  release:
    if: github.actor == 'doringeman' || github.actor == 'xenoscopic' || github.actor == 'ericcurtin' || github.actor == 'ilopezluna'
    runs-on: ubuntu-latest
    steps:
      - name: Set up Crane
        run: |
          curl -LO https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz
          tar -xzvf go-containerregistry_Linux_x86_64.tar.gz crane
          sudo mv crane /usr/local/bin/
          crane version

      - name: Log in to DockerHub
        env:
          DOCKERHUB_USERNAME: "docker"
          DOCKERHUB_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}
        run: crane auth login index.docker.io -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"

      - name: Promote CPU images
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Promoting CPU images"
          crane tag "docker/model-runner:$VERSION" "latest"

      - name: Promote CUDA images
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Promoting CUDA images"
          crane tag "docker/model-runner:$VERSION-cuda" "latest-cuda"

      - name: Promote vLLM CUDA images
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Promoting vLLM CUDA images"
          crane tag "docker/model-runner:$VERSION-vllm-cuda" "latest-vllm-cuda"

      - name: Promote SGLang CUDA images
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Promoting SGLang CUDA images"
          crane tag "docker/model-runner:$VERSION-sglang-cuda" "latest-sglang-cuda"

      - name: Promote ROCm images
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Promoting ROCm images"
          crane tag "docker/model-runner:$VERSION-rocm" "latest-rocm"

      - name: Promote MUSA images
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Checking if MUSA image exists"
          if crane manifest "docker/model-runner:$VERSION-musa" > /dev/null 2>&1; then
            echo "Promoting MUSA images"
            crane tag "docker/model-runner:$VERSION-musa" "latest-musa"
          else
            echo "MUSA image does not exist, skipping"
          fi

      - name: Promote CANN images
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Checking if CANN image exists"
          if crane manifest "docker/model-runner:$VERSION-cann" > /dev/null 2>&1; then
            echo "Promoting CANN images"
            crane tag "docker/model-runner:$VERSION-cann" "latest-cann"
          else
            echo "CANN image does not exist, skipping"
          fi
