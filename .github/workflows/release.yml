name: Release
run-name: >-
  Release
  ${{ inputs.releaseTag != '' && inputs.releaseTag || format('(auto {0} bump)', inputs.bumpType || 'patch') }}
  ${{ inputs.pushLatest && ' + latest' || '' }}

on:
  workflow_dispatch:
    inputs:
      bumpType:
        description: "Version bump type (ignored when releaseTag is provided)"
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: "patch"
      releaseTag:
        description: "Explicit release tag ‚Äî overrides auto-bump (e.g., v1.2.3)"
        required: false
        type: string
      pushLatest:
        description: "Tag images produced by this job as latest"
        required: false
        type: boolean
        default: false
      llamaServerVersion:
        description: "llama-server version"
        required: false
        type: string
        default: "latest"
      vllmVersion:
        description: "vLLM version"
        required: false
        type: string
        default: "0.12.0"
      sglangVersion:
        description: "SGLang version"
        required: false
        type: string
        default: "0.4.0"
      # This can be removed once we have llama.cpp built for MUSA and CANN.
      buildMusaCann:
        description: "Build MUSA and CANN images"
        required: false
        type: boolean
        default: false

jobs:
  # ---------------------------------------------------------------------------
  # Determine or create the release tag.
  # Auto-bumps the latest tag (or uses explicit releaseTag if provided).
  # ---------------------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
      version: ${{ steps.resolve.outputs.version }}
      previous_tag: ${{ steps.resolve.outputs.previous_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: resolve
        env:
          EXPLICIT_TAG: ${{ inputs.releaseTag }}
          BUMP_TYPE: ${{ inputs.bumpType || 'patch' }}
        run: |
          # --- Find the latest existing v* tag ---
          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -1)
          echo "Latest existing tag: ${LATEST_TAG:-<none>}"

          if [ -n "$EXPLICIT_TAG" ]; then
            # Validate explicit tag format
            if ! echo "$EXPLICIT_TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo "::error::Invalid release tag format: '$EXPLICIT_TAG'. Expected format: v<MAJOR>.<MINOR>.<PATCH> (e.g., v1.2.3)"
              exit 1
            fi
            # Explicit tag provided ‚Äî use it directly
            RELEASE_TAG="$EXPLICIT_TAG"
            VERSION="${EXPLICIT_TAG#v}"
            PREVIOUS_TAG="$LATEST_TAG"
            echo "Explicit tag provided: $RELEASE_TAG"

          else
            # Auto-bump from latest tag
            if [ -z "$LATEST_TAG" ]; then
              echo "No existing tags found ‚Äî starting at v0.1.0"
              RELEASE_TAG="v0.1.0"
              VERSION="0.1.0"
              PREVIOUS_TAG=""
            else
              PREVIOUS_TAG="$LATEST_TAG"
              # Strip leading 'v' for parsing
              VERSION="${LATEST_TAG#v}"
              MAJOR=$(echo "$VERSION" | cut -d. -f1)
              MINOR=$(echo "$VERSION" | cut -d. -f2)
              PATCH=$(echo "$VERSION" | cut -d. -f3)

              case "$BUMP_TYPE" in
                major)
                  MAJOR=$((MAJOR + 1))
                  MINOR=0
                  PATCH=0
                  ;;
                minor)
                  MINOR=$((MINOR + 1))
                  PATCH=0
                  ;;
                patch)
                  PATCH=$((PATCH + 1))
                  ;;
              esac

              VERSION="${MAJOR}.${MINOR}.${PATCH}"
              RELEASE_TAG="v${VERSION}"
              echo "Auto-bumped $BUMP_TYPE: $LATEST_TAG ‚Üí $RELEASE_TAG"
            fi
          fi

          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "previous_tag=${PREVIOUS_TAG:-}" >> "$GITHUB_OUTPUT"
          echo "üè∑Ô∏è  Release tag:  $RELEASE_TAG"
          echo "üè∑Ô∏è  Version:      $VERSION"
          echo "üè∑Ô∏è  Previous tag: ${PREVIOUS_TAG:-<none>}"

      - name: Create and push tag
        env:
          RELEASE_TAG: ${{ steps.resolve.outputs.release_tag }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if the tag already exists
          if git rev-parse "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $RELEASE_TAG already exists ‚Äî skipping creation"
            exit 0
          fi

          echo "Creating tag $RELEASE_TAG on $(git rev-parse --short HEAD)"
          git tag "$RELEASE_TAG"
          git push origin "$RELEASE_TAG"
          echo "‚úÖ Tag $RELEASE_TAG created and pushed"

  # ---------------------------------------------------------------------------
  # Generate release notes using cagent AI agent (runs in parallel with test)
  # ---------------------------------------------------------------------------
  release-notes:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Generate release notes
        uses: docker/cagent-action@a893bceeae87a21b91ca2b09459365e51f765e5d
        with:
          agent: .github/agents/release-notes-generator.yaml
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            **Release Tag:** ${{ needs.prepare.outputs.release_tag }}
            **Previous Tag:** ${{ needs.prepare.outputs.previous_tag }}
            **Repository:** docker/model-runner

      - name: Verify release notes
        env:
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
          PREVIOUS_TAG: ${{ needs.prepare.outputs.previous_tag }}
        run: |
          if [ ! -f "release-notes.md" ]; then
            echo "::warning::Release notes were not generated. Using fallback."
            echo "## What's Changed" > release-notes.md
            echo "" >> release-notes.md
            if [ -n "$PREVIOUS_TAG" ]; then
              echo "**Full Changelog**: https://github.com/docker/model-runner/compare/${PREVIOUS_TAG}...${RELEASE_TAG}" >> release-notes.md
            else
              echo "**Full Changelog**: https://github.com/docker/model-runner/tree/${RELEASE_TAG}" >> release-notes.md
            fi
          fi
          echo "‚úÖ Release notes:"
          cat release-notes.md

      - name: Upload release notes
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: release-notes
          path: release-notes.md

  # ---------------------------------------------------------------------------
  # Run tests
  # ---------------------------------------------------------------------------
  test:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: 1.25.6
          cache: true

      - name: Run tests
        run: go test -race ./...

  # ---------------------------------------------------------------------------
  # Build and push Docker images
  # ---------------------------------------------------------------------------
  build:
    needs: [prepare, test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
      LLAMA_SERVER_VERSION: ${{ inputs.llamaServerVersion || 'latest' }}
      VLLM_VERSION: ${{ inputs.vllmVersion || '0.12.0' }}
      SGLANG_VERSION: ${{ inputs.sglangVersion || '0.4.0' }}
      PUSH_LATEST: ${{ inputs.pushLatest || 'false' }}
      BUILD_MUSA_CANN: ${{ inputs.buildMusaCann || 'false' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Format tags
        id: tags
        shell: bash
        run: |
          echo "cpu<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"
          echo "cuda<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG-cuda" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest-cuda" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"
          echo "vllm-cuda<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG-vllm-cuda" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest-vllm-cuda" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"
          echo "sglang-cuda<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG-sglang-cuda" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest-sglang-cuda" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"
          echo "diffusers<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG-diffusers" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest-diffusers" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"
          echo "rocm<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG-rocm" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest-rocm" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"
          echo "musa<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG-musa" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest-musa" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"
          echo "cann<<EOF" >> "$GITHUB_OUTPUT"
          echo "docker/model-runner:$RELEASE_TAG-cann" >> "$GITHUB_OUTPUT"
          if [ "$PUSH_LATEST" == "true" ]; then
            echo "docker/model-runner:latest-cann" >> "$GITHUB_OUTPUT"
          fi
          echo 'EOF' >> "$GITHUB_OUTPUT"

      - name: Log in to DockerHub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          username: "docker"
          password: ${{ secrets.ORG_ACCESS_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0
        with:
          version: "lab:latest"
          driver: cloud
          endpoint: "docker/make-product-smarter"
          install: true

      - name: Build CPU image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-llamacpp
          platforms: linux/amd64, linux/arm64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.cpu }}

      - name: Build CUDA image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-llamacpp
          platforms: linux/amd64, linux/arm64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
            "LLAMA_SERVER_VARIANT=cuda"
            "BASE_IMAGE=nvidia/cuda:12.9.0-runtime-ubuntu24.04"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.cuda }}

      - name: Build vLLM CUDA image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-vllm
          platforms: linux/amd64, linux/arm64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
            "LLAMA_SERVER_VARIANT=cuda"
            "BASE_IMAGE=nvidia/cuda:13.0.2-runtime-ubuntu24.04"
            "VLLM_VERSION=${{ env.VLLM_VERSION }}"
            "VLLM_CUDA_VERSION=cu130"
            "VLLM_PYTHON_TAG=cp38-abi3"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.vllm-cuda }}

      - name: Build SGLang CUDA image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-sglang
          platforms: linux/amd64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
            "LLAMA_SERVER_VARIANT=cuda"
            "BASE_IMAGE=nvidia/cuda:12.9.0-runtime-ubuntu24.04"
            "SGLANG_VERSION=${{ env.SGLANG_VERSION }}"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.sglang-cuda }}

      - name: Build Diffusers image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-diffusers
          platforms: linux/amd64, linux/arm64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.diffusers }}

      - name: Build ROCm image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-llamacpp
          platforms: linux/amd64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
            "LLAMA_SERVER_VARIANT=rocm"
            "BASE_IMAGE=rocm/dev-ubuntu-22.04"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.rocm }}

      - name: Build MUSA image
        if: ${{ env.BUILD_MUSA_CANN == 'true' }}
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-llamacpp
          platforms: linux/amd64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
            "LLAMA_SERVER_VARIANT=musa"
            "BASE_IMAGE=mthreads/musa:rc4.3.0-runtime-ubuntu22.04-amd64"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.musa }}

      - name: Build CANN image
        if: ${{ env.BUILD_MUSA_CANN == 'true' }}
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          file: Dockerfile
          target: final-llamacpp
          platforms: linux/arm64, linux/amd64
          build-args: |
            "LLAMA_SERVER_VERSION=${{ env.LLAMA_SERVER_VERSION }}"
            "LLAMA_SERVER_VARIANT=cann"
            "BASE_IMAGE=ascendai/cann:8.2.rc2-910b-ubuntu22.04-py3.11"
          push: true
          sbom: true
          provenance: mode=max
          tags: ${{ steps.tags.outputs.cann }}

  # ---------------------------------------------------------------------------
  # Trigger model-cli-release workflow (private repo ‚Äî signs binaries)
  # ---------------------------------------------------------------------------
  trigger-model-cli-release:
    needs: [prepare, test, release-notes]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download release notes
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: release-notes

      - name: Read release notes
        id: notes
        run: |
          # Read release notes, base64-encode to safely pass multiline content
          NOTES_B64=$(base64 < release-notes.md)
          echo "changelog_b64=$NOTES_B64" >> "$GITHUB_OUTPUT"

      - name: Trigger model-cli-release workflow
        env:
          GH_TOKEN: ${{ secrets.CLI_RELEASE_PAT }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo "üöÄ Triggering model-cli-release workflow"
          echo "   ref: $RELEASE_TAG"
          echo "   release_tag: v$VERSION"
          gh workflow run release.yml \
            --repo docker/model-cli-release \
            -f ref="$RELEASE_TAG" \
            -f release_tag="v$VERSION" \
            -f changelog_b64="${{ steps.notes.outputs.changelog_b64 }}"
          echo "‚úÖ model-cli-release workflow triggered"

  # ---------------------------------------------------------------------------
  # Trigger Docker CE packaging workflow
  # ---------------------------------------------------------------------------
  trigger-packaging:
    if: ${{ !inputs.skipPackaging }}
    needs: [prepare, trigger-model-cli-release]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger release-model workflow in packaging repo
        env:
          GH_TOKEN: ${{ secrets.CLI_RELEASE_PAT }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
        run: |
          echo "üì¶ Triggering release-model workflow in docker/packaging"
          echo "   tag_ref: $RELEASE_TAG"
          gh workflow run release-model.yml \
            --repo docker/packaging \
            -f tag="$RELEASE_TAG"
          echo "‚úÖ release-model workflow triggered in docker/packaging"

      - name: Post instructions for release-repo
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<-SUMMARY
          ## üìã Next Steps: Release to Docker CE

          The \`release-model\` workflow has been triggered in \`docker/packaging\`.
          Once it completes, follow these manual steps:

          ### 1. Get the packaging image tag

          Check the [release-model workflow runs](https://github.com/docker/packaging/actions/workflows/release-model.yml)
          for the image tag. It will look like:
          \`\`\`
          dockereng/packaging:model-v${VERSION}-<build_number>
          \`\`\`

          ### 2. Trigger the plugin release

          Run the [release buildx, compose, model, cagent](https://github.com/docker/release-repo/actions/workflows/plugin.yml) workflow with:

          | Parameter | Value |
          |-----------|-------|
          | **Image** | \`dockereng/packaging:model-v${VERSION}-<build_number>\` |
          | **Expected version** | \`${VERSION}\` (no v-prefix) |
          | **Release channel** | \`stable\` |
          | **Deploy to live** | ‚úÖ Yes |

          > **Tag reference used:** \`${RELEASE_TAG}\`
          SUMMARY

          echo "üìã Instructions for docker/release-repo have been added to the job summary"

  # ---------------------------------------------------------------------------
  # Create GitHub Release with AI-generated release notes
  # ---------------------------------------------------------------------------
  github-release:
    needs: [prepare, release-notes, build, trigger-model-cli-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download release notes
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: release-notes

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo "Creating GitHub Release for $RELEASE_TAG"
          gh release create "$RELEASE_TAG" \
            --repo docker/model-runner \
            --title "Docker Model Runner $RELEASE_TAG" \
            --notes-file release-notes.md
